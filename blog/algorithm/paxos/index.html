<!DOCTYPE html>

<html lang="zh-cn"><head>
  <meta charset="utf-8">
  <title>go Paxos | Louis Blog</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="有技术 有温度 有情怀">
  
  <meta name="author" content="Louis ">
  <meta name="generator" content="Hugo 0.73.0" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/plugins/slick/slick.css">
  
  <link rel="stylesheet" href="/plugins/fontawesome/font-awesome.min.css">
  
  <link rel="stylesheet" href="/plugins/animate/animate.css">
  
  <link rel="stylesheet" href="/plugins/venobox/venobox.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="/images/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="/images/images/favicon.png " type="image/x-icon">

  <!--Algolia-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css">
</head>
<body>
<!-- header -->
<header>
  

  <!-- navigation -->
  <div class="navigation bg-white position-relative">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <a class="navbar-brand" href="/"><img class="img-fluid pb-lg-3" src="/images/images/logo.png" width="189px" alt="Louis Blog"></a>
        <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="/"></a>
            </li>
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                博客
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/categories/kubernetes">Kubernetes</a>
                
                <a class="dropdown-item" href="/categories/sealos">sealos</a>
                
                <a class="dropdown-item" href="/categories/ops">运维相关</a>
                
                <a class="dropdown-item" href="/categories/golang">golang</a>
                
                <a class="dropdown-item" href="/categories/algorithm">algorithm</a>
                
                <a class="dropdown-item" href="/categories/tools">tools</a>
                
                <a class="dropdown-item" href="/blog">全部</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/team">友情链接</a>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                关于我
              </a>
              <div class="dropdown-menu" >
                
                <a class="dropdown-item" href="/contact">about</a>
                
                <a class="dropdown-item" href="https://github.com/oldthreefeng">github</a>
                
              </div>
            </li>
            
            
          </ul>

          
          

          
          <!-- search -->
          <div class="search px-4">
            <button id="searchOpen" class="search-btn"><i class="fa fa-search text-dark"></i></button>
            <div class="search-wrapper">
              <form action="/search">
                <input class="search-box form-control" id="js-algolia-btn" name="s" type="search" placeholder="输入搜索词">
              </form>
              <button id="searchClose" class="search-close"><i class="fa fa-close text-dark"></i></button>
            </div>
          </div>
          
          
          <!-- get start btn -->
          <a href="/contact" class="btn btn-primary hover-ripple">联系我</a>
          
        </div>
      </nav>
    </div>
  </div>
  <!-- /navigation -->
</header>
<!-- /header -->


<!-- page title -->
<section class="section bg-cover overlay" style="background-image: url('/'),url('/'),url('/images/images/backgrounds/page-title.jpg');">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h2 class="text-white mb-3">go Paxos</h2>
        <!-- breadcrumb -->
        
        <p class="text-white"></p>
      </div>
    </div>
  </div>
</section>
<!-- /page title -->


<!-- blog details -->
<section class="section">
  <div class="container blog">
    <div class="row">
      <div class="col-lg-8">
        <!-- post thumb -->
        <div class="position-relative mb-5">
          <img src="/"  onerror="this.src='https:\/\/pic.fenghong.tech\/proto\/003.jpeg'" alt="post thumb" class="img-fluid w-100">
           <div class="card-type">Algorithm</div>
        </div>
        <div class="card-meta text-uppercase mb-2">作者  <strong class="text-dark"><a href="https://www.fenghong.tech">Louis</a></strong>
          
            发表于 <strong class="text-dark">2019年8月28日</strong></div>
        <hr>
        <div class="content">
          <p>[TOC]</p>
<h1 id="paxos">Paxos</h1>
<h2 id="问题描述和假设">问题描述和假设</h2>
<p>分布式系统中的节点通信存在两种模型：<a href="https://zh.wikipedia.org/wiki/%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98">共享内存</a>（Shared memory）和<a href="https://zh.wikipedia.org/wiki/%E6%B6%88%E6%81%AF%E4%BC%A0%E9%80%92">消息传递</a>（Messages passing）。基于消息传递通信模型的分布式系统，不可避免的会发生以下错误：进程可能会慢、被杀死或者重启，消息可能会延迟、丢失、重复，在基础 Paxos 场景中，先不考虑可能出现消息篡改即<a href="https://zh.wikipedia.org/wiki/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98">拜占庭错误</a>的情况。Paxos 算法解决的问题是在一个可能发生上述异常的<a href="https://zh.wikipedia.org/wiki/%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97">分布式系统</a>中如何就某个值达成一致，保证不论发生以上任何异常，都不会破坏决议的一致性。一个典型的场景是，在一个分布式数据库系统中，如果各节点的初始状态一致，每个节点都执行相同的操作序列，那么他们最后能得到一个一致的状态。为保证每个节点执行相同的命令序列，需要在每一条指令上执行一个“一致性算法”以保证每个节点看到的指令一致。一个通用的一致性算法可以应用在许多场景中，是分布式计算中的重要问题。因此从20世纪80年代起对于一致性算法的研究就没有停止过。</p>
<p>为描述Paxos算法，Lamport虚拟了一个叫做Paxos的<a href="https://zh.wikipedia.org/wiki/%E5%B8%8C%E8%87%98%E5%9F%8E%E9%82%A6">希腊城邦</a>，这个岛按照议会民主制的政治模式制订法律，但是没有人愿意将自己的全部时间和精力放在这种事情上。所以无论是议员，议长或者传递纸条的服务员都不能承诺别人需要时一定会出现，也无法承诺批准决议或者传递消息的时间。但是这里假设没有<a href="https://zh.wikipedia.org/wiki/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98">拜占庭将军问题</a>（Byzantine failure，即虽然有可能一个消息被传递了两次，但是绝对不会出现错误的消息）；只要等待足够的时间，消息就会被传到。另外，Paxos岛上的议员是不会反对其他议员提出的决议的。</p>
<p>对应于分布式系统，议员对应于各个节点，制定的法律对应于系统的状态。各个节点需要进入一个一致的状态，例如在独立<a href="https://zh.wikipedia.org/wiki/Cache">Cache</a>的<a href="https://zh.wikipedia.org/w/index.php?title=%E5%AF%B9%E7%A7%B0%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8&amp;action=edit&amp;redlink=1">对称多处理器</a>系统中，各个处理器读内存的某个字节时，必须读到同样的一个值，否则系统就违背了一致性的要求。一致性要求对应于法律条文只能有一个版本。议员和服务员的不确定性对应于节点和消息传递通道的不可靠性</p>
<h3 id="算法的提出与证明">算法的提出与证明</h3>
<p>首先将议员的角色分为 proposers，acceptors，和 learners（允许身兼数职）。proposers 提出提案，提案信息包括提案编号和提议的 value；acceptor 收到提案后可以接受（accept）提案，若提案获得多数派（majority）的 acceptors 的接受，则称该提案被批准（chosen）；learners 只能“学习”被批准的提案。划分角色后，就可以更精确的定义问题：</p>
<ol>
<li>决议（value）只有在被 proposers 提出后才能被批准（未经批准的决议称为“提案（proposal）”）；</li>
<li>在一次 Paxos 算法的执行实例中，只批准（chosen）一个 value；</li>
<li>learners 只能获得被批准（chosen）的 value。</li>
</ol>
<pre><code>在 Leslie Lamport 之后发表的paper中将 majority 替换为更通用的 quorum 概念，但在描述classic paxos的论文  Paxos made simple 中使用的还是majority的概念。
</code></pre><p>另外还需要保证 progress。这一点以后再讨论。</p>
<p>作者通过不断加强上述3个约束（主要是第二个）获得了 Paxos 算法。</p>
<p>批准 value 的过程中，首先 proposers 将 value 发送给 acceptors，之后 acceptors 对 value 进行接受（accept）。为了满足只批准一个 value 的约束，要求经“多数派（majority）”接受的 value 成为正式的决议（称为“批准”决议）。这是因为无论是按照人数还是按照权重划分，两组“多数派”至少有一个公共的 acceptor，如果每个 acceptor 只能接受一个 value，约束2就能保证。</p>
<p>于是产生了一个显而易见的新约束：</p>
<pre><code>P1：一个 acceptor 必须接受（accept）第一次收到的提案。
</code></pre><p>注意 P1 是不完备的。如果恰好一半 acceptor 接受的提案具有 value A，另一半接受的提案具有 value B，那么就无法形成多数派，无法批准任何一个 value。</p>
<p>约束2并不要求只批准一个提案，暗示可能存在多个提案。只要提案的 value 是一样的，批准多个提案不违背约束2。于是可以产生约束 P2：</p>
<pre><code>P2：一旦一个具有 value v 的提案被批准（chosen），那么之后批准（chosen）的提案必须具有 value v。
</code></pre><p>注：通过某种方法可以为每个提案分配一个编号，在提案之间建立一个全序关系，所谓“之后”都是指所有编号更大的提案。</p>
<p>如果 P1 和 P2 都能够保证，那么约束2就能够保证。</p>
<p>批准一个 value 意味着多个 acceptor 接受（accept）了该 value。因此，可以对 P2 进行加强：</p>
<pre><code>P2a：一旦一个具有 value v 的提案被批准（chosen），那么之后任何 acceptor 再次接受（accept）的提案必须具有 value v。
</code></pre><p>由于通信是异步的，P2a 和 P1 会发生冲突。如果一个 value 被批准后，一个 proposer 和一个 acceptor 从休眠中苏醒，前者提出一个具有新的 value 的提案。根据 P1，后者应当接受，根据 P2a，则不应当接受，这种场景下 P2a 和 P1 有矛盾。于是需要换个思路，转而对 proposer 的行为进行约束：</p>
<pre><code>P2b：一旦一个具有 value v 的提案被批准（chosen），那么以后任何 proposer 提出的提案必须具有 value v。
</code></pre><p>由于 acceptor 能接受的提案都必须由 proposer 提出，所以 P2b 蕴涵了 P2a，是一个更强的约束。</p>
<p>但是根据 P2b 难以提出实现手段。因此需要进一步加强 P2b。</p>
<p>假设一个编号为 m 的 value v 已经获得批准（chosen），来看看在什么情况下对任何编号为 n（n&gt;m）的提案都含有 value v。因为 m 已经获得批准（chosen），显然存在一个 acceptors 的多数派 C，他们都接受（accept）了v。考虑到任何多数派都和 C 具有至少一个公共成员，可以找到一个蕴涵 P2b 的约束 P2c：</p>
<pre><code>P2c：如果一个编号为 n 的提案具有 value v，那么存在一个多数派，要么他们中所有人都没有接受（accept）编号小于 n 
的任何提案，要么他们已经接受（accept）的所有编号小于 n 的提案中编号最大的那个提案具有 value v。
</code></pre><p>可以用<a href="https://zh.wikipedia.org/wiki/%E6%95%B0%E5%AD%A6%E5%BD%92%E7%BA%B3%E6%B3%95">数学归纳法</a>证明 P2c 蕴涵 P2b：</p>
<p>假设具有value v的提案m获得批准，当n=m+1时，采用反证法，假如提案n不具有value v，而是具有value w，根据P2c，则存在一个多数派S1，要么他们中没有人接受过编号小于n的任何提案，要么他们已经接受的所有编号小于n的提案中编号最大的那个提案是value w。由于S1和通过提案m时的多数派C之间至少有一个公共的acceptor，所以以上两个条件都不成立，导出矛盾从而推翻假设，证明了提案n必须具有value v；</p>
<p>若（m+1）..（N-1）所有提案都具有value v，采用反证法，假如新提案N不具有value v，而是具有value w&rsquo;,根据P2c，则存在一个多数派S2，要么他们没有接受过m..（N-1）中的任何提案，要么他们已经接受的所有编号小于N的提案中编号最大的那个提案是value w&rsquo;。由于S2和通过m的多数派C之间至少有一个公共的acceptor，所以至少有一个acceptor曾经接受了m，从而也可以推出S2中已接受的所有编号小于n的提案中编号最大的那个提案的编号范围在m..（N-1）之间，而根据初始假设，m..（N-1）之间的所有提案都具有value v，所以S2中已接受的所有编号小于n的提案中编号最大的那个提案肯定具有value v，导出矛盾从而推翻新提案n不具有value v的假设。根据数学归纳法，我们证明了若满足P2c，则P2b一定满足。</p>
<p>P2c是可以通过消息传递模型实现的。另外，引入了P2c后，也解决了前文提到的P1不完备的问题。</p>
<h2 id="golang实现"><code>golang</code>实现</h2>
<h3 id="实现的步骤">实现的步骤</h3>
<pre><code>//a. Proposer选择一个提案编号N，然后向半数以上的Acceptor发送编号为N的Prepare请求。
//a.1 生成编号N的算法为 `p.lastSeq &lt;&lt;16 | p.id`

//b. acceptor返回promise,并保证小于n的提案不在接收

//c.1 更新proposer里面的acceptor,保证proposer存入的acceptor提案N为最新
//c.2 acceptor里返回的promise达到半数以上
//c.3 如果Proposer收到半数以上Acceptor对其发出的编号为N的Prepare请求的响应，
//   那么它就会发送一个针对[N,V]提案的Accept请求给半数以上的Acceptor

// d. 接收proposer的提案N,如果已接收提案N&gt;返回的propose的提案N,则忽略
//    如果已接收提案N&lt; 返回的propose提案N,说明错误;违反了P2c原则
//    如果相同,则接收提案N,将propose提案存入accept里面,并将accept.typ改为接受.

//e. 将accept信息发送至learner,通知learner我接受提案N

//f. learner等待acceptor发送accept mes
//f.1 如果消息类型不为Accept, 返回错误
//f.2 从accepted消息中来进行比对,如果接收的提案N &gt; learner存入的提案N,需要重新学习;否则就忽略

//g. 如果半数以上的learner选择了提案N,则说明选择完毕
</code></pre><h3 id="代码">代码</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">/*
</span><span style="color:#75715e">@Time : 2019/8/27 18:39
</span><span style="color:#75715e">@Author : louis
</span><span style="color:#75715e">@File : paxos
</span><span style="color:#75715e">@Software: GoLand
</span><span style="color:#75715e">*/</span>

<span style="color:#f92672">package</span> <span style="color:#a6e22e">paxos</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">const</span> (
	<span style="color:#75715e">//Prepare 准备发送的消息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Prepare</span> = <span style="color:#66d9ef">iota</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
	<span style="color:#75715e">//Propose 待批准的消息-提案消息,并保证小于n的提案不在接收
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Propose</span>
	<span style="color:#75715e">//Promise accept返回的消息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Promise</span>
	<span style="color:#75715e">//Accept 已经接收的提案
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Accept</span>
)

<span style="color:#75715e">//promise 接口只能获取消息的提案号
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">promise</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">number</span>() <span style="color:#66d9ef">int</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">accept</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">//accept接口获取提案的值
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proposalValue</span>() <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//accept接口获取提案的号
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proposalNumber</span>() <span style="color:#66d9ef">int</span>
}

<span style="color:#75715e">//mes 消息体
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">mes</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">from</span>, <span style="color:#a6e22e">to</span> <span style="color:#66d9ef">int</span>    <span style="color:#75715e">//消息发送\接收
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">typ</span>      <span style="color:#66d9ef">int</span>    <span style="color:#75715e">//消息类型
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">n</span>        <span style="color:#66d9ef">int</span>    <span style="color:#75715e">//提案号
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pren</span>     <span style="color:#66d9ef">int</span>    <span style="color:#75715e">//前一个提案号
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">value</span>    <span style="color:#66d9ef">string</span> <span style="color:#75715e">//提案值value
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">//proposalValue 只有是accept和promise类型的消息,才具备提案value值
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#a6e22e">mes</span>) <span style="color:#a6e22e">proposalValue</span>() <span style="color:#66d9ef">string</span> {
	<span style="color:#75715e">//返回value需要什么条件呢？
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">typ</span> {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Accept</span>, <span style="color:#a6e22e">Promise</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">value</span>
	<span style="color:#66d9ef">default</span>:
		panic(<span style="color:#e6db74">&#34;unexpect proposalValue&#34;</span>)
	}

}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#a6e22e">mes</span>) <span style="color:#a6e22e">proposalNumber</span>() <span style="color:#66d9ef">int</span> {
	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">typ</span> {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Promise</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">pren</span>
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Accept</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">n</span>
	<span style="color:#66d9ef">default</span>:
		panic(<span style="color:#e6db74">&#34;unexpect proposalNumber&#34;</span>)
	}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#a6e22e">mes</span>) <span style="color:#a6e22e">number</span>() <span style="color:#66d9ef">int</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">n</span>
}

<span style="color:#75715e">//network to send and recv mes
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">network</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">m</span> <span style="color:#a6e22e">mes</span>)
	<span style="color:#a6e22e">recv</span>(<span style="color:#a6e22e">timeout</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>) (<span style="color:#a6e22e">mes</span>, <span style="color:#66d9ef">bool</span>)
}

<span style="color:#75715e">// paxosNet paxos 的消息管道,recv[i]消息的接收i接收的信息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">paxosNet</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">recv</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">mes</span>
}

<span style="color:#75715e">// newPaxNet 生成paxosNet,根据agent的数量生成
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newPaxNet</span>(<span style="color:#a6e22e">agents</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">paxosNet</span> {
	<span style="color:#a6e22e">pn</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">paxosNet</span>{<span style="color:#a6e22e">recv</span>: make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">mes</span>, <span style="color:#ae81ff">0</span>)}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">agents</span> {
		<span style="color:#a6e22e">pn</span>.<span style="color:#a6e22e">recv</span>[<span style="color:#a6e22e">a</span>] = make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">mes</span>, <span style="color:#ae81ff">1024</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">pn</span>
}

<span style="color:#75715e">//send 发送消息mes至pn中的接收者i
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">pn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">paxosNet</span>) <span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">m</span> <span style="color:#a6e22e">mes</span>) {
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;nt send message :%+v&#34;</span>, <span style="color:#a6e22e">m</span>)
	<span style="color:#a6e22e">pn</span>.<span style="color:#a6e22e">recv</span>[<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">to</span>] <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">m</span>
}

<span style="color:#75715e">//rec 从agent接收mes,并输出,返回信息mes和bool.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">pn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">paxosNet</span>) <span style="color:#a6e22e">rec</span>(<span style="color:#a6e22e">from</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">timeout</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>) (<span style="color:#a6e22e">mes</span>, <span style="color:#66d9ef">bool</span>) {
	<span style="color:#66d9ef">select</span> {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">pn</span>.<span style="color:#a6e22e">recv</span>[<span style="color:#a6e22e">from</span>]:
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;nt recv message :%+v&#34;</span>, <span style="color:#a6e22e">m</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>, <span style="color:#66d9ef">true</span>
	<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">After</span>(<span style="color:#a6e22e">timeout</span>):
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mes</span>{}, <span style="color:#66d9ef">false</span>
	}
}

<span style="color:#75715e">//agentNet 根据agent的id生成AgentNet结构体
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">pn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">paxosNet</span>) <span style="color:#a6e22e">agentNet</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">agentNet</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">agentNet</span>{<span style="color:#a6e22e">id</span>: <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">pn</span>: <span style="color:#a6e22e">pn</span>}
}

<span style="color:#75715e">//Empty 判断pn是不是空
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">pn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">paxosNet</span>) <span style="color:#a6e22e">empty</span>() <span style="color:#66d9ef">bool</span> {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">n</span> <span style="color:#66d9ef">int</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">q</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">pn</span>.<span style="color:#a6e22e">recv</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;nt %+v left %d&#34;</span>, <span style="color:#a6e22e">i</span>, len(<span style="color:#a6e22e">q</span>))
		<span style="color:#a6e22e">n</span> <span style="color:#f92672">+=</span> len(<span style="color:#a6e22e">q</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
}

<span style="color:#75715e">//AgentNet 代理网络结构体,存放代理的id号和pn消息网络结构体
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">agentNet</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">pn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">paxosNet</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">an</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">agentNet</span>) <span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">m</span> <span style="color:#a6e22e">mes</span>) {
	<span style="color:#a6e22e">an</span>.<span style="color:#a6e22e">pn</span>.<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">m</span>)
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">an</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">agentNet</span>) <span style="color:#a6e22e">recv</span>(<span style="color:#a6e22e">timeout</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>) (<span style="color:#a6e22e">mes</span>, <span style="color:#66d9ef">bool</span>) {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">an</span>.<span style="color:#a6e22e">pn</span>.<span style="color:#a6e22e">rec</span>(<span style="color:#a6e22e">an</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">timeout</span>)
}

<span style="color:#75715e">//proposer 提案提出者
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">proposer</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">id</span>        <span style="color:#66d9ef">int</span>    <span style="color:#75715e">//提案号
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">lastSeq</span>   <span style="color:#66d9ef">int</span>    <span style="color:#75715e">//上一条Seq消息好
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">value</span>     <span style="color:#66d9ef">string</span> <span style="color:#75715e">//提案的value
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">valueN</span>    <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">acceptors</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#a6e22e">promise</span> <span style="color:#75715e">//接受者的消息map
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">nt</span>        <span style="color:#a6e22e">network</span> <span style="color:#75715e">//paxos的网络
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">//newPropose 生成新的提案提出者proposer
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newPropose</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">nt</span> <span style="color:#a6e22e">network</span>, <span style="color:#a6e22e">acceptors</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">proposer</span> {
	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">proposer</span>{
		<span style="color:#a6e22e">id</span>:        <span style="color:#a6e22e">id</span>,
		<span style="color:#a6e22e">lastSeq</span>:   <span style="color:#ae81ff">0</span>,
		<span style="color:#a6e22e">nt</span>:        <span style="color:#a6e22e">nt</span>,
		<span style="color:#a6e22e">value</span>:     <span style="color:#a6e22e">value</span>,
		<span style="color:#a6e22e">acceptors</span>: make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#a6e22e">promise</span>),
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">acceptors</span> { <span style="color:#75715e">//遍历acceptors,生成proposer
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">acceptors</span>[<span style="color:#a6e22e">a</span>] = <span style="color:#a6e22e">mes</span>{}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">proposer</span>) <span style="color:#a6e22e">run</span>() {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ok</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">m</span> <span style="color:#a6e22e">mes</span>
	<span style="color:#75715e">//c.2 acceptor里返回的promise达到半数以上
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> !<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">quorumCheck</span>() {
		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
			<span style="color:#75715e">//a. Proposer准备prepare,生成提案编号N，然后向半数以上的Acceptor发送编号为N的Prepare请求。
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">ms</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">prepare</span>()
			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">ms</span> {
				<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">nt</span>.<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">ms</span>[<span style="color:#a6e22e">i</span>])
			}
		}
		<span style="color:#a6e22e">m</span>, <span style="color:#a6e22e">ok</span> = <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">nt</span>.<span style="color:#a6e22e">recv</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
		<span style="color:#75715e">// 返回数据失败,说明此次的prepare失败,重新prepare
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
			<span style="color:#66d9ef">continue</span>
		}
		<span style="color:#75715e">// prepare成功
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">typ</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Promise</span>:
			<span style="color:#75715e">//c.1 更新proposer里面的acceptor,保证proposer存入的acceptor提案N为最新
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">receivePromise</span>(<span style="color:#a6e22e">m</span>)
		<span style="color:#66d9ef">default</span>:
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panicf</span>(<span style="color:#e6db74">&#34;proposer: %d unexpected message type: %v&#34;</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">typ</span>)
		}
	}
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d promise %d reached quorum %d&#34;</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">n</span>(), <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">quorum</span>())
	<span style="color:#75715e">//c.3 如果Proposer收到半数以上Acceptor对其发出的编号为N的Prepare请求的响应，
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//   那么它就会发送一个针对[N,V]提案的Accept请求给半数以上的Acceptor
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ms</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">propose</span>()
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">ms</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;proposer %d: &#34;</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span>)
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">nt</span>.<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">ms</span>[<span style="color:#a6e22e">i</span>])
	}
}

<span style="color:#75715e">//大多数,半数+1即为大多数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">proposer</span>) <span style="color:#a6e22e">quorum</span>() <span style="color:#66d9ef">int</span> {
	<span style="color:#66d9ef">return</span> len(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">acceptors</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
}

<span style="color:#75715e">//c.2 acceptor返回的promise大于半数以上同意
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">proposer</span>) <span style="color:#a6e22e">quorumCheck</span>() <span style="color:#66d9ef">bool</span> {
	<span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">promise</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">acceptors</span> {
		<span style="color:#75715e">// promise里面的提案N 必须和 proposer的提案N相同.
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">promise</span>.<span style="color:#a6e22e">number</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">n</span>() {
			<span style="color:#a6e22e">m</span><span style="color:#f92672">++</span>
		}
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">quorum</span>() {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
}

<span style="color:#75715e">//在一个paxos实例中，每个提案需要有不同的编号，且编号间要存在全序关系
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">proposer</span>) <span style="color:#a6e22e">n</span>() <span style="color:#66d9ef">int</span> {
	<span style="color:#75715e">// 把&#34;&lt;&lt;&#34;左边的运算数的各二进位全部左移若干位，由&#34;&lt;&lt;&#34;右边的数指定移动的位数，高位丢弃，低位补0
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 再把结果和p.id 进行或运算,将1位合并置1
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">lastSeq</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">16</span> | <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span>
}

<span style="color:#75715e">//c.3 如果Proposer收到半数以上Acceptor对其发出的编号为N的Prepare请求的响应，把proposer的value携带上.
</span><span style="color:#75715e">//   那么它就会发送一个针对[N,V]提案的Accept请求给半数以上的Acceptor
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">proposer</span>) <span style="color:#a6e22e">propose</span>() []<span style="color:#a6e22e">mes</span> {
	<span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">mes</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">quorum</span>())
	<span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
	<span style="color:#75715e">// 取acceptors里面的index,promise,只能取promise里面的mes.n
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">to</span>, <span style="color:#a6e22e">promise</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">acceptors</span> {
		<span style="color:#75715e">//如果acceptors的n,和proposer的提案n相等,即acceptor接收proposer的提案n.
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">promise</span>.<span style="color:#a6e22e">number</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">n</span>() {
			<span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#a6e22e">mes</span>{
				<span style="color:#a6e22e">from</span>:  <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span>,
				<span style="color:#a6e22e">to</span>:    <span style="color:#a6e22e">to</span>,
				<span style="color:#a6e22e">typ</span>:   <span style="color:#a6e22e">Propose</span>,
				<span style="color:#a6e22e">n</span>:     <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">n</span>(),
				<span style="color:#a6e22e">value</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">value</span>,
			}
			<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">quorum</span>() {
			<span style="color:#66d9ef">break</span>
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>
}

<span style="color:#75715e">//a. Proposer选择一个提案编号N，然后向半数以上的Acceptor发送编号为N的Prepare请求。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">proposer</span>) <span style="color:#a6e22e">prepare</span>() []<span style="color:#a6e22e">mes</span> {
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">lastSeq</span><span style="color:#f92672">++</span>
	<span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">mes</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">quorum</span>())
	<span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
	<span style="color:#75715e">// 只取acceptors里面的index,即acceptors
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">to</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">acceptors</span> {
		<span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#a6e22e">mes</span>{
			<span style="color:#a6e22e">from</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span>,
			<span style="color:#a6e22e">to</span>:   <span style="color:#a6e22e">to</span>,
			<span style="color:#a6e22e">typ</span>:  <span style="color:#a6e22e">Prepare</span>,
			<span style="color:#a6e22e">n</span>:    <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">n</span>(),
		}
		<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">quorum</span>() {
			<span style="color:#66d9ef">break</span>
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>
}

<span style="color:#75715e">//c.1 更新proposer里面的acceptor,保证proposer存入的acceptor提案N为最新
</span><span style="color:#75715e">// 从acceptor接收的promise消息.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">proposer</span>) <span style="color:#a6e22e">receivePromise</span>(<span style="color:#a6e22e">promise</span> <span style="color:#a6e22e">mes</span>) {
	<span style="color:#a6e22e">prePromise</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">acceptors</span>[<span style="color:#a6e22e">promise</span>.<span style="color:#a6e22e">from</span>]
	<span style="color:#75715e">// 从acceptor接收的promise和propose里面的number进行比对
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// propose.acceptors[promise.from].number() &lt; promise.number()
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 返回的promise大,则更新proposer里面的promise为最新版.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">prePromise</span>.<span style="color:#a6e22e">number</span>() &lt; <span style="color:#a6e22e">promise</span>.<span style="color:#a6e22e">number</span>() {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;proposer: %d received a new promise %+v&#34;</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">promise</span>)
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">acceptors</span>[<span style="color:#a6e22e">promise</span>.<span style="color:#a6e22e">from</span>] = <span style="color:#a6e22e">promise</span>
		<span style="color:#75715e">//acceptors返回的提案preN &gt; proposer的N
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">promise</span>.<span style="color:#a6e22e">proposalNumber</span>() &gt; <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">valueN</span> {
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;proposer: %d updated the value [%s] to %s&#34;</span>,
				<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">value</span>, <span style="color:#a6e22e">promise</span>.<span style="color:#a6e22e">proposalValue</span>())
			<span style="color:#75715e">//promise.pren = p.n()
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">valueN</span> = <span style="color:#a6e22e">promise</span>.<span style="color:#a6e22e">proposalNumber</span>()
			<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">value</span> = <span style="color:#a6e22e">promise</span>.<span style="color:#a6e22e">proposalValue</span>()
		}
	}
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">acceptor</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">int</span>
	<span style="color:#75715e">//一旦acceptor接收提案propose;
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 便需要通知所有learners,通信总次数为 M * N
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//TODO 通知learner集合,再由learner集合通知剩下的learner
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">learners</span> []<span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">accept</span>   <span style="color:#a6e22e">mes</span>
	<span style="color:#a6e22e">promised</span> <span style="color:#a6e22e">promise</span>
	<span style="color:#a6e22e">nt</span>       <span style="color:#a6e22e">network</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newAcceptor</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">nt</span> <span style="color:#a6e22e">network</span>, <span style="color:#a6e22e">learners</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">acceptor</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">acceptor</span>{
		<span style="color:#a6e22e">id</span>:       <span style="color:#a6e22e">id</span>,
		<span style="color:#a6e22e">nt</span>:       <span style="color:#a6e22e">nt</span>,
		<span style="color:#a6e22e">promised</span>: <span style="color:#a6e22e">mes</span>{},
		<span style="color:#a6e22e">learners</span>: <span style="color:#a6e22e">learners</span>,
	}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">acceptor</span>) <span style="color:#a6e22e">run</span>() {
	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">m</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">nt</span>.<span style="color:#a6e22e">recv</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Hour</span>)
		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
			<span style="color:#66d9ef">continue</span>
		}
		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">typ</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Propose</span>:
			<span style="color:#75715e">//d. 接收proposer的提案N,如果已接收提案N&gt;返回的propose的提案N,则忽略
</span><span style="color:#75715e"></span>			<span style="color:#75715e">//    如果已接收提案N&lt; 返回的propose提案N,说明错误;违反了P2c原则
</span><span style="color:#75715e"></span>			<span style="color:#75715e">//    如果相同,则接收提案N,将propose提案存入accept里面,并将accept.typ改为接受.
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">accepted</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">receivePropose</span>(<span style="color:#a6e22e">m</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">accepted</span> {
				<span style="color:#75715e">//e. 将accept信息发送至learner,通知learner我接受提案N
</span><span style="color:#75715e"></span>				<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">l</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">learners</span> {
					<span style="color:#a6e22e">m</span> = <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">accept</span>
					<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">from</span> = <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">id</span>
					<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">to</span> = <span style="color:#a6e22e">l</span>
					<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">nt</span>.<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">m</span>)
				}
			}
			<span style="color:#75715e">//b. acceptor返回promise,并保证小于n的提案不在接收
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Prepare</span>:
			<span style="color:#a6e22e">promised</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">receivePrepare</span>(<span style="color:#a6e22e">m</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> {
				<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">nt</span>.<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">promised</span>)
			}
		<span style="color:#66d9ef">default</span>:
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panicf</span>(<span style="color:#e6db74">&#34;accepted : %d message tpye unknwon: %d&#34;</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">typ</span>)
		}
	}
}

<span style="color:#75715e">// d. 接收proposer的提案N,如果已接收提案N&gt;返回的propose的提案N,则忽略
</span><span style="color:#75715e">//    如果已接收提案N&lt; 返回的propose提案N,说明错误;违反了P2c原则
</span><span style="color:#75715e">//    如果相同,则接收提案N,将propose提案存入accept里面,并将accept.typ改为接受.
</span><span style="color:#75715e">//P2c：如果一个编号为 n 的提案具有 value v，那么存在一个多数派，要么他们中所有人都没有接受（accept）编号小于 n
</span><span style="color:#75715e">//的任何提案，要么他们已经接受（accept）的所有编号小于 n 的提案中编号最大的那个提案具有 value v。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">acceptor</span>) <span style="color:#a6e22e">receivePropose</span>(<span style="color:#a6e22e">propose</span> <span style="color:#a6e22e">mes</span>) <span style="color:#66d9ef">bool</span> {
	<span style="color:#75715e">// 已接收提案N &gt; propose的mes.n;不接收这个提案
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">promised</span>.<span style="color:#a6e22e">number</span>() &gt; <span style="color:#a6e22e">propose</span>.<span style="color:#a6e22e">number</span>() {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;acceptor %d [promised: %+v] ignored propose mes: %+v&#34;</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">promised</span>, <span style="color:#a6e22e">propose</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
	}
	<span style="color:#75715e">//已接收提案N &lt; propose的mes.n;
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">promised</span>.<span style="color:#a6e22e">number</span>() &lt; <span style="color:#a6e22e">propose</span>.<span style="color:#a6e22e">number</span>() {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panicf</span>(<span style="color:#e6db74">&#34;acceptor %d [promised: %+v] received unexpected proposal mes: %+v&#34;</span>,
			<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">promised</span>, <span style="color:#a6e22e">propose</span>)
	}
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;acceptor %d [promised: %+v, accept: %+v]  accepted propose: %+v&#34;</span>,
		<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">promised</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">accept</span>, <span style="color:#a6e22e">propose</span>)
	<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">accept</span> = <span style="color:#a6e22e">propose</span>
	<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">accept</span>.<span style="color:#a6e22e">typ</span> = <span style="color:#a6e22e">Accept</span>
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
}

<span style="color:#75715e">//b. acceptor返回promise,并保证小于n的提案不在接收
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">acceptor</span>) <span style="color:#a6e22e">receivePrepare</span>(<span style="color:#a6e22e">prepare</span> <span style="color:#a6e22e">mes</span>) (<span style="color:#a6e22e">promised</span> <span style="color:#a6e22e">mes</span>, <span style="color:#a6e22e">b</span> <span style="color:#66d9ef">bool</span>) {
	<span style="color:#75715e">// 如果获取的m.n大于提案N,Promised提案接收,承诺不再接收任何小于N的提案
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// P1:一个 acceptor 必须接受（accept）第一次收到的提案。
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">promised</span>.<span style="color:#a6e22e">number</span>() &lt; <span style="color:#a6e22e">prepare</span>.<span style="color:#a6e22e">number</span>() {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;acceptor %d [promised: %+v]  promised %+v&#34;</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">promised</span>, <span style="color:#a6e22e">prepare</span>)
		<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">promised</span> = <span style="color:#a6e22e">prepare</span>
		<span style="color:#75715e">//把消息返回
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">promised</span> = <span style="color:#a6e22e">mes</span>{
			<span style="color:#a6e22e">typ</span>:   <span style="color:#a6e22e">Promise</span>,
			<span style="color:#a6e22e">from</span>:  <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">id</span>,
			<span style="color:#a6e22e">to</span>:    <span style="color:#a6e22e">prepare</span>.<span style="color:#a6e22e">from</span>,
			<span style="color:#a6e22e">n</span>:     <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">promised</span>.<span style="color:#a6e22e">number</span>(),
			<span style="color:#a6e22e">pren</span>:  <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">accept</span>.<span style="color:#a6e22e">n</span>,
			<span style="color:#a6e22e">value</span>: <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">accept</span>.<span style="color:#a6e22e">value</span>,
		}
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">promised</span>, <span style="color:#66d9ef">true</span>
	}
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;acceptor %d [promised: %+v] ignored prepare mes: %+v&#34;</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">promised</span>, <span style="color:#a6e22e">prepare</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mes</span>{}, <span style="color:#66d9ef">false</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">learner</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">id</span>        <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">acceptors</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#a6e22e">accept</span>
	<span style="color:#a6e22e">nt</span>        <span style="color:#a6e22e">network</span>
	<span style="color:#a6e22e">value</span>     <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">string</span> <span style="color:#75715e">//测试数据比对,learner学习后得到的提案N对应的V[N,V]
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newLearner</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">nt</span> <span style="color:#a6e22e">network</span>, <span style="color:#a6e22e">acceptors</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">learner</span> {
	<span style="color:#a6e22e">l</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">learner</span>{<span style="color:#a6e22e">id</span>: <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">nt</span>: <span style="color:#a6e22e">nt</span>, <span style="color:#a6e22e">acceptors</span>: make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#a6e22e">accept</span>), <span style="color:#a6e22e">value</span>: make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">string</span>)}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">acceptors</span> {
		<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">acceptors</span>[<span style="color:#a6e22e">a</span>] = <span style="color:#a6e22e">mes</span>{<span style="color:#a6e22e">typ</span>: <span style="color:#a6e22e">Accept</span>}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">l</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">learner</span>) <span style="color:#a6e22e">GetValue</span>() (<span style="color:#a6e22e">v</span> <span style="color:#66d9ef">string</span>) {
	<span style="color:#66d9ef">select</span> {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">value</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>
	<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">After</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>):
		<span style="color:#66d9ef">return</span>
	}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">learner</span>) <span style="color:#a6e22e">learn</span>() {
	<span style="color:#66d9ef">for</span> {
		<span style="color:#75715e">//f. 等待acceptor发送accept mes,
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">m</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">nt</span>.<span style="color:#a6e22e">recv</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Hour</span>)
		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
			<span style="color:#66d9ef">continue</span>
		}
		<span style="color:#75715e">//f.1 如果消息类型不为Accept, 返回错误
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">typ</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">Accept</span> {
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panicf</span>(<span style="color:#e6db74">&#34;learner :%d receive an unexpected proposal mes: %+v&#34;</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">m</span>)
		}
		<span style="color:#75715e">//f.2 从accepted消息中来进行比对,如果接收的提案N &gt; learner存入的提案N,需要重新学习;否则就忽略
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">receiveAccept</span>(<span style="color:#a6e22e">m</span>)
		<span style="color:#75715e">//g. 如果半数以上的learner选择了提案N,则说明选择完毕
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">accept</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">chosen</span>()
		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
			<span style="color:#66d9ef">continue</span>
		}
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;learner :%d has chosen proposal : %v &#34;</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">accept</span>)
		<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">value</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">accept</span>.<span style="color:#a6e22e">proposalValue</span>()
		<span style="color:#66d9ef">return</span>
	}
}

<span style="color:#75715e">//g. 如果半数的learner选择了提案N,则说明选择完毕
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">learner</span>) <span style="color:#a6e22e">chosen</span>() (<span style="color:#a6e22e">accept</span>, <span style="color:#66d9ef">bool</span>) {

	<span style="color:#a6e22e">counts</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#66d9ef">int</span>)
	<span style="color:#a6e22e">accepts</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#a6e22e">accept</span>)

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">accepted</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">acceptors</span> {
		<span style="color:#75715e">// 统计learner接收提案的次数;为0说明没有接收过提案
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">accepted</span>.<span style="color:#a6e22e">proposalNumber</span>() <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">counts</span>[<span style="color:#a6e22e">accepted</span>.<span style="color:#a6e22e">proposalNumber</span>()]<span style="color:#f92672">++</span>
			<span style="color:#a6e22e">accepts</span>[<span style="color:#a6e22e">accepted</span>.<span style="color:#a6e22e">proposalNumber</span>()] = <span style="color:#a6e22e">accepted</span>
		}
	}

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">count</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">counts</span> {
		<span style="color:#75715e">// quorum达到即返回
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">count</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">quorum</span>() {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">accepts</span>[<span style="color:#a6e22e">n</span>], <span style="color:#66d9ef">true</span>
		}
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mes</span>{}, <span style="color:#66d9ef">false</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">learner</span>) <span style="color:#a6e22e">quorum</span>() <span style="color:#66d9ef">int</span> {
	<span style="color:#66d9ef">return</span> len(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">acceptors</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
}

<span style="color:#75715e">//f.2 从accepted消息中来进行比对,如果接收的提案N &gt; learner存入的提案N,需要重新学习;否则就忽略
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">learner</span>) <span style="color:#a6e22e">receiveAccept</span>(<span style="color:#a6e22e">accepted</span> <span style="color:#a6e22e">mes</span>) {
	<span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">acceptors</span>[<span style="color:#a6e22e">accepted</span>.<span style="color:#a6e22e">from</span>]
	<span style="color:#75715e">// 提案N &lt; 接收的 N; 需要接收大于N的提案
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">proposalNumber</span>() &lt; <span style="color:#a6e22e">accepted</span>.<span style="color:#a6e22e">n</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;learner %d has learned a new proposal mes: %+v&#34;</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">accepted</span>)
		<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">acceptors</span>[<span style="color:#a6e22e">accepted</span>.<span style="color:#a6e22e">from</span>] = <span style="color:#a6e22e">accepted</span>
	}
}
</code></pre></div><p>看着大佬的代码理解了一遍;测试函数如下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">/*
</span><span style="color:#75715e">@Time : 2019/8/27 22:17
</span><span style="color:#75715e">@Author : Administrator
</span><span style="color:#75715e">@File : test_paxos
</span><span style="color:#75715e">@Software: GoLand
</span><span style="color:#75715e">*/</span>

<span style="color:#f92672">package</span> <span style="color:#a6e22e">paxos</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;testing&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">node</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">key</span>  <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">next</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">node</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestN</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">first</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">node</span>{}
	<span style="color:#a6e22e">cur</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">node</span>{}
	<span style="color:#a6e22e">lastSeq</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
	<span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
	<span style="color:#75715e">// 保证生成的数不相同
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 生成编号 N 的提案  测试了1亿级别的数据,耗时15.53s
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// --- PASS: TestN (15.53s)
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">num</span> = <span style="color:#ae81ff">10000000</span>

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">id</span> = <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">id</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">num</span>; <span style="color:#a6e22e">id</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">node</span>{<span style="color:#a6e22e">key</span>: <span style="color:#a6e22e">lastSeq</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">16</span> | <span style="color:#a6e22e">id</span>}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">id</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">first</span> = <span style="color:#a6e22e">n</span>
			<span style="color:#a6e22e">cur</span> = <span style="color:#a6e22e">n</span>
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#a6e22e">cur</span>.<span style="color:#a6e22e">next</span> = <span style="color:#a6e22e">n</span>
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cur</span>.<span style="color:#a6e22e">key</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">cur</span>.<span style="color:#a6e22e">next</span>.<span style="color:#a6e22e">key</span> {
				<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;有重复元素: %+v&#34;</span>, <span style="color:#a6e22e">cur</span>.<span style="color:#a6e22e">key</span>)
			}
			<span style="color:#a6e22e">cur</span> = <span style="color:#a6e22e">n</span>
			<span style="color:#a6e22e">lastSeq</span><span style="color:#f92672">++</span>
		}
	}
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">first</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestSingleProposer</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#75715e">// 1,2,3,4,5 acceptors
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 1001 proposer
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 2001 learner
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newPaxNet</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">1001</span>, <span style="color:#ae81ff">2001</span>)
	<span style="color:#a6e22e">ac</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">acceptor</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">5</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">ac</span> = append(<span style="color:#a6e22e">ac</span>, <span style="color:#a6e22e">newAcceptor</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">pn</span>.<span style="color:#a6e22e">agentNet</span>(<span style="color:#a6e22e">i</span>), <span style="color:#ae81ff">2001</span>))
	}

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">ac</span> {
		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">run</span>()
	}
	<span style="color:#a6e22e">wantValue</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;hello world&#34;</span>
	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newPropose</span>(<span style="color:#ae81ff">1001</span>, <span style="color:#a6e22e">wantValue</span>, <span style="color:#a6e22e">pn</span>.<span style="color:#a6e22e">agentNet</span>(<span style="color:#ae81ff">1001</span>), <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">run</span>()

	<span style="color:#a6e22e">l</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newLearner</span>(<span style="color:#ae81ff">2001</span>, <span style="color:#a6e22e">pn</span>.<span style="color:#a6e22e">agentNet</span>(<span style="color:#ae81ff">2001</span>), <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">learn</span>()
	<span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">GetValue</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">wantValue</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;value = %s wanted value = %s&#34;</span>, <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">wantValue</span>)
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestTwoPropose</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#75715e">// 1,2,3 acceptors
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 1001,1002 proposer
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 2001 learner
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newPaxNet</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">1001</span>, <span style="color:#ae81ff">1002</span>, <span style="color:#ae81ff">2001</span>)
	<span style="color:#a6e22e">ac</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">acceptor</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">3</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">ac</span> = append(<span style="color:#a6e22e">ac</span>, <span style="color:#a6e22e">newAcceptor</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">pn</span>.<span style="color:#a6e22e">agentNet</span>(<span style="color:#a6e22e">i</span>), <span style="color:#ae81ff">2001</span>))
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">ac</span> {
		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">run</span>()
	}

	<span style="color:#a6e22e">wantV1</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;hello world&#34;</span>
	<span style="color:#a6e22e">p1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newPropose</span>(<span style="color:#ae81ff">1001</span>, <span style="color:#a6e22e">wantV1</span>, <span style="color:#a6e22e">pn</span>.<span style="color:#a6e22e">agentNet</span>(<span style="color:#ae81ff">1001</span>), <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">p1</span>.<span style="color:#a6e22e">run</span>()

	<span style="color:#a6e22e">wantV2</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;hello world v2&#34;</span>
	<span style="color:#75715e">// 提出提案N 此时lastSeq++;
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newPropose</span>(<span style="color:#ae81ff">1002</span>, <span style="color:#a6e22e">wantV2</span>, <span style="color:#a6e22e">pn</span>.<span style="color:#a6e22e">agentNet</span>(<span style="color:#ae81ff">1002</span>), <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">p2</span>.<span style="color:#a6e22e">run</span>()

	<span style="color:#a6e22e">l</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newLearner</span>(<span style="color:#ae81ff">2001</span>, <span style="color:#a6e22e">pn</span>.<span style="color:#a6e22e">agentNet</span>(<span style="color:#ae81ff">2001</span>), <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">learn</span>()
	<span style="color:#a6e22e">va</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">GetValue</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">va</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">wantV2</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;value = %s,wantValue = %s&#34;</span>, <span style="color:#a6e22e">va</span>, <span style="color:#a6e22e">wantV2</span>)
	}

}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestNPropose</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">pn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newPaxNet</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">1001</span>, <span style="color:#ae81ff">1002</span>, <span style="color:#ae81ff">1003</span>, <span style="color:#ae81ff">2001</span>, <span style="color:#ae81ff">2002</span>)
	<span style="color:#a6e22e">ac</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">acceptor</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">3</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">ac</span> = append(<span style="color:#a6e22e">ac</span>, <span style="color:#a6e22e">newAcceptor</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">pn</span>.<span style="color:#a6e22e">agentNet</span>(<span style="color:#a6e22e">i</span>), <span style="color:#ae81ff">2001</span>, <span style="color:#ae81ff">2002</span>))
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">ac</span> {
		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">run</span>()
	}
	<span style="color:#a6e22e">pp</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">proposer</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1001</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1003</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">wantStr</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;hello world v&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprint</span>(<span style="color:#a6e22e">i</span>)
		<span style="color:#a6e22e">pp</span> = append(<span style="color:#a6e22e">pp</span>, <span style="color:#a6e22e">newPropose</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">wantStr</span>, <span style="color:#a6e22e">pn</span>.<span style="color:#a6e22e">agentNet</span>(<span style="color:#a6e22e">i</span>), <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>))
	}

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">pp</span> {
		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">run</span>()
	}
	<span style="color:#75715e">//这里模拟两个learner
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ln</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">learner</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">2001</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">2002</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">ln</span> = append(<span style="color:#a6e22e">ln</span>, <span style="color:#a6e22e">newLearner</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">pn</span>.<span style="color:#a6e22e">agentNet</span>(<span style="color:#a6e22e">i</span>), <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>))
	}
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">v</span> [<span style="color:#ae81ff">2</span>]<span style="color:#66d9ef">string</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">l</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">ln</span> {
		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">learn</span>()
		<span style="color:#a6e22e">v</span>[<span style="color:#a6e22e">k</span>] = <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">GetValue</span>()
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> <span style="color:#a6e22e">v</span>[<span style="color:#ae81ff">1</span>] {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;value = %s,wantValue = %s&#34;</span>, <span style="color:#a6e22e">v</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">v</span>[<span style="color:#ae81ff">1</span>])
	}
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">500</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
}

</code></pre></div><h3 id="验证结果">验证结果:</h3>
<pre><code>=== RUN   TestNPropose
2019/08/28 18:58:29 nt send message :{from:1001 to:1 typ:1 n:66537 pren:0 value:}
2019/08/28 18:58:29 nt send message :{from:1001 to:2 typ:1 n:66537 pren:0 value:}
2019/08/28 18:58:29 nt recv message :{from:1001 to:1 typ:1 n:66537 pren:0 value:}
2019/08/28 18:58:29 acceptor 1 [promised: {from:0 to:0 typ:0 n:0 pren:0 value:}]  promised {from:1001 to:1 typ:1 n:66537 pren:0 value:}
2019/08/28 18:58:29 nt send message :{from:1 to:1001 typ:3 n:66537 pren:0 value:}
2019/08/28 18:58:29 nt recv message :{from:1001 to:2 typ:1 n:66537 pren:0 value:}
2019/08/28 18:58:29 acceptor 2 [promised: {from:0 to:0 typ:0 n:0 pren:0 value:}]  promised {from:1001 to:2 typ:1 n:66537 pren:0 value:}
2019/08/28 18:58:29 nt send message :{from:2 to:1001 typ:3 n:66537 pren:0 value:}
2019/08/28 18:58:29 nt send message :{from:1002 to:3 typ:1 n:66538 pren:0 value:}
2019/08/28 18:58:29 nt send message :{from:1002 to:1 typ:1 n:66538 pren:0 value:}
2019/08/28 18:58:29 nt recv message :{from:1002 to:1 typ:1 n:66538 pren:0 value:}
2019/08/28 18:58:29 acceptor 1 [promised: {from:1001 to:1 typ:1 n:66537 pren:0 value:}]  promised {from:1002 to:1 typ:1 n:66538 pren:0 value:}
2019/08/28 18:58:29 nt send message :{from:1 to:1002 typ:3 n:66538 pren:0 value:}
2019/08/28 18:58:29 nt recv message :{from:1 to:1002 typ:3 n:66538 pren:0 value:}
2019/08/28 18:58:29 proposer: 1002 received a new promise {from:1 to:1002 typ:3 n:66538 pren:0 value:}
2019/08/28 18:58:29 nt send message :{from:1003 to:1 typ:1 n:66539 pren:0 value:}
2019/08/28 18:58:29 nt send message :{from:1003 to:2 typ:1 n:66539 pren:0 value:}
2019/08/28 18:58:29 nt recv message :{from:1003 to:2 typ:1 n:66539 pren:0 value:}
2019/08/28 18:58:29 acceptor 2 [promised: {from:1001 to:2 typ:1 n:66537 pren:0 value:}]  promised {from:1003 to:2 typ:1 n:66539 pren:0 value:}
2019/08/28 18:58:29 nt send message :{from:2 to:1003 typ:3 n:66539 pren:0 value:}
2019/08/28 18:58:29 nt recv message :{from:2 to:1003 typ:3 n:66539 pren:0 value:}
2019/08/28 18:58:29 proposer: 1003 received a new promise {from:2 to:1003 typ:3 n:66539 pren:0 value:}
2019/08/28 18:58:29 nt recv message :{from:1002 to:3 typ:1 n:66538 pren:0 value:}
2019/08/28 18:58:29 acceptor 3 [promised: {from:0 to:0 typ:0 n:0 pren:0 value:}]  promised {from:1002 to:3 typ:1 n:66538 pren:0 value:}
2019/08/28 18:58:29 nt send message :{from:3 to:1002 typ:3 n:66538 pren:0 value:}
2019/08/28 18:58:29 nt recv message :{from:3 to:1002 typ:3 n:66538 pren:0 value:}
2019/08/28 18:58:29 proposer: 1002 received a new promise {from:3 to:1002 typ:3 n:66538 pren:0 value:}
2019/08/28 18:58:29 1002 promise 66538 reached quorum 2
proposer 1002: 2019/08/28 18:58:29 nt send message :{from:1002 to:1 typ:2 n:66538 pren:0 value:hello world v1002}
proposer 1002: 2019/08/28 18:58:29 nt send message :{from:1002 to:3 typ:2 n:66538 pren:0 value:hello world v1002}
2019/08/28 18:58:29 nt recv message :{from:1002 to:3 typ:2 n:66538 pren:0 value:hello world v1002}
2019/08/28 18:58:29 acceptor 3 [promised: {from:1002 to:3 typ:1 n:66538 pren:0 value:}, accept: {from:0 to:0 typ:0 n:0 pren:0 value:}]  accepted propose: {from:1002 to:3 typ:2 n:66538 pren:0 value:hello world v1002}
2019/08/28 18:58:29 nt send message :{from:3 to:2001 typ:4 n:66538 pren:0 value:hello world v1002}
2019/08/28 18:58:29 nt send message :{from:3 to:2002 typ:4 n:66538 pren:0 value:hello world v1002}
2019/08/28 18:58:29 nt recv message :{from:3 to:2001 typ:4 n:66538 pren:0 value:hello world v1002}
2019/08/28 18:58:29 learner 2001 has learned a new proposal mes: {from:3 to:2001 typ:4 n:66538 pren:0 value:hello world v1002}
2019/08/28 18:58:29 nt recv message :{from:1003 to:1 typ:1 n:66539 pren:0 value:}
2019/08/28 18:58:29 acceptor 1 [promised: {from:1002 to:1 typ:1 n:66538 pren:0 value:}]  promised {from:1003 to:1 typ:1 n:66539 pren:0 value:}
2019/08/28 18:58:29 nt send message :{from:1 to:1003 typ:3 n:66539 pren:0 value:}
2019/08/28 18:58:29 nt recv message :{from:1002 to:1 typ:2 n:66538 pren:0 value:hello world v1002}
2019/08/28 18:58:29 acceptor 1 [promised: {from:1003 to:1 typ:1 n:66539 pren:0 value:}] ignored propose mes: {from:1002 to:1 typ:2 n:66538 pren:0 value:hello world v1002}
2019/08/28 18:58:29 nt recv message :{from:1 to:1003 typ:3 n:66539 pren:0 value:}
2019/08/28 18:58:29 proposer: 1003 received a new promise {from:1 to:1003 typ:3 n:66539 pren:0 value:}
2019/08/28 18:58:29 1003 promise 66539 reached quorum 2
proposer 1003: 2019/08/28 18:58:29 nt send message :{from:1003 to:1 typ:2 n:66539 pren:0 value:hello world v1003}
proposer 1003: 2019/08/28 18:58:29 nt send message :{from:1003 to:2 typ:2 n:66539 pren:0 value:hello world v1003}
2019/08/28 18:58:29 nt recv message :{from:1003 to:2 typ:2 n:66539 pren:0 value:hello world v1003}
2019/08/28 18:58:29 acceptor 2 [promised: {from:1003 to:2 typ:1 n:66539 pren:0 value:}, accept: {from:0 to:0 typ:0 n:0 pren:0 value:}]  accepted propose: {from:1003 to:2 typ:2 n:66539 pren:0 value:hello world v1003}
2019/08/28 18:58:29 nt send message :{from:2 to:2001 typ:4 n:66539 pren:0 value:hello world v1003}
2019/08/28 18:58:29 nt send message :{from:2 to:2002 typ:4 n:66539 pren:0 value:hello world v1003}
2019/08/28 18:58:29 nt recv message :{from:2 to:2001 typ:4 n:66539 pren:0 value:hello world v1003}
2019/08/28 18:58:29 learner 2001 has learned a new proposal mes: {from:2 to:2001 typ:4 n:66539 pren:0 value:hello world v1003}
2019/08/28 18:58:29 nt recv message :{from:1003 to:1 typ:2 n:66539 pren:0 value:hello world v1003}
2019/08/28 18:58:29 acceptor 1 [promised: {from:1003 to:1 typ:1 n:66539 pren:0 value:}, accept: {from:0 to:0 typ:0 n:0 pren:0 value:}]  accepted propose: {from:1003 to:1 typ:2 n:66539 pren:0 value:hello world v1003}
2019/08/28 18:58:29 nt send message :{from:1 to:2001 typ:4 n:66539 pren:0 value:hello world v1003}
2019/08/28 18:58:29 nt send message :{from:1 to:2002 typ:4 n:66539 pren:0 value:hello world v1003}
2019/08/28 18:58:29 nt recv message :{from:1 to:2001 typ:4 n:66539 pren:0 value:hello world v1003}
2019/08/28 18:58:29 learner 2001 has learned a new proposal mes: {from:1 to:2001 typ:4 n:66539 pren:0 value:hello world v1003}
2019/08/28 18:58:29 learner :2001 has chosen proposal : {2 2001 4 66539 0 hello world v1003} 
2019/08/28 18:58:29 nt recv message :{from:3 to:2002 typ:4 n:66538 pren:0 value:hello world v1002}
2019/08/28 18:58:29 learner 2002 has learned a new proposal mes: {from:3 to:2002 typ:4 n:66538 pren:0 value:hello world v1002}
2019/08/28 18:58:29 nt recv message :{from:2 to:2002 typ:4 n:66539 pren:0 value:hello world v1003}
2019/08/28 18:58:29 learner 2002 has learned a new proposal mes: {from:2 to:2002 typ:4 n:66539 pren:0 value:hello world v1003}
2019/08/28 18:58:29 nt recv message :{from:1 to:2002 typ:4 n:66539 pren:0 value:hello world v1003}
2019/08/28 18:58:29 learner 2002 has learned a new proposal mes: {from:1 to:2002 typ:4 n:66539 pren:0 value:hello world v1003}
2019/08/28 18:58:29 learner :2002 has chosen proposal : {2 2002 4 66539 0 hello world v1003} 
2019/08/28 18:58:29 nt recv message :{from:1 to:1001 typ:3 n:66537 pren:0 value:}
2019/08/28 18:58:29 proposer: 1001 received a new promise {from:1 to:1001 typ:3 n:66537 pren:0 value:}
2019/08/28 18:58:29 nt recv message :{from:2 to:1001 typ:3 n:66537 pren:0 value:}
2019/08/28 18:58:29 proposer: 1001 received a new promise {from:2 to:1001 typ:3 n:66537 pren:0 value:}
2019/08/28 18:58:29 1001 promise 66537 reached quorum 2
proposer 1001: 2019/08/28 18:58:29 nt send message :{from:1001 to:1 typ:2 n:66537 pren:0 value:hello world v1001}
proposer 1001: 2019/08/28 18:58:29 nt send message :{from:1001 to:2 typ:2 n:66537 pren:0 value:hello world v1001}
2019/08/28 18:58:29 nt recv message :{from:1001 to:2 typ:2 n:66537 pren:0 value:hello world v1001}
2019/08/28 18:58:29 acceptor 2 [promised: {from:1003 to:2 typ:1 n:66539 pren:0 value:}] ignored propose mes: {from:1001 to:2 typ:2 n:66537 pren:0 value:hello world v1001}
2019/08/28 18:58:29 nt recv message :{from:1001 to:1 typ:2 n:66537 pren:0 value:hello world v1001}
2019/08/28 18:58:29 acceptor 1 [promised: {from:1003 to:1 typ:1 n:66539 pren:0 value:}] ignored propose mes: {from:1001 to:1 typ:2 n:66537 pren:0 value:hello world v1001}
--- PASS: TestNPropose (0.65s)
PASS
</code></pre><p>当有3个acceptor(1,2,3),2个proposer(1001,1002),2个learner(2001,2002),能证明learner最终能chosen统一的提案N.</p>
<h3 id="参考">参考</h3>
<ul>
<li>大佬的<a href="https://github.com/xiang90/paxos">github传送车</a></li>
<li><a href="https://zh.wikipedia.org/wiki/Paxos%E7%AE%97%E6%B3%95">维基百科</a></li>
</ul>

        </div>
        <!-- tags -->
        <div class="mb-3">
          <h5 class="d-inline-block mr-3">Tags:</h5>
          <ul class="list-inline d-inline-block">
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/go"> 
            Go</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/paxos"> , 
            Paxos</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/algorithm"> , 
            Algorithm</a>
            
          </ul>
        </div>
        <!-- previous -->
        <div class="mb-3 link-article">
    <div class="pre-article">
        
            <div><i class="fa fa-arrow-left"></i> 上一篇</div>
            <a href="https://www.fenghong.tech/blog/go/go-filemode/">go filemode 源码理解</a>
        
    </div>
    <div class="next-article">
        
            <div>下一篇 <i class="fa fa-arrow-right"></i></div>
            <a href="https://www.fenghong.tech/blog/go/go-mod/">go module</a>
        
    </div>
</div>
        <!-- previous -->

        <!-- recommend -->
        

<div class="mb-3">
  <h2>文章推荐</h2>
  <ul class="related">
  
    <li><a href="/blog/intro/distribute/">分布式</a></li>
  
    <li><a href="/blog/go/go-flag/">go flag</a></li>
  
    <li><a href="/blog/go/go-filemode/">go filemode 源码理解</a></li>
  
    <li><a href="/blog/go/go-channel/">Go channel 理解</a></li>
  
    <li><a href="/blog/go/gin-use-in-webhook/">gin实现webhook</a></li>
  
  </ul>
</div>


        <!-- comments -->

        
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
        <script>
          window.onload = function() {
              const gitalk = new Gitalk({
              clientID: 'a0a546df858aafb5300e',
              clientSecret: '67d7b40de25c072fc38840ffb9c06ceab7ef5080',
              repo: 'oldthreefeng.github.io',
              owner: 'oldthreefeng',
              admin: ['oldthreefeng'],
              id: hex_md5(hex_md5(window.location.pathname + window.location.hash)), 
              distractionFreeMode: false 
            });
            (function() {
              if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
                document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
                return;
              }
              gitalk.render('gitalk-container');
            })();
          }
        </script>
        
      </div>
      <!-- sidebar -->
<aside class="col-lg-4 order-1 order-lg-2">
  <!-- tags -->
  <div class="bg-white px-4 py-5 box-shadow mb-5 word-cloud">
    <h4 class="mb-4">标签</h4>
    
      
      
      
      
      
      
      
      
      
      
      
      <div id="tag-cloud" style="padding: 5px 15px">
      
        
          
          
          
          <a href="/tags/acme" style="font-size:1.0188679245283019rem">acme</a>
        
      
        
          
          
          &middot;
          <a href="/tags/acmetiny" style="font-size:1.0188679245283019rem">acmetiny</a>
        
      
        
          
          
          &middot;
          <a href="/tags/alertmanager" style="font-size:1rem">alertmanager</a>
        
      
        
          
          
          &middot;
          <a href="/tags/algorithm" style="font-size:1.1132075471698113rem">algorithm</a>
        
      
        
          
          
          &middot;
          <a href="/tags/aliyun" style="font-size:1rem">aliyun</a>
        
      
        
          
          
          &middot;
          <a href="/tags/ansible" style="font-size:1.0754716981132075rem">ansible</a>
        
      
        
          
          
          &middot;
          <a href="/tags/apisix" style="font-size:1rem">apisix</a>
        
      
        
          
          
          &middot;
          <a href="/tags/arm64" style="font-size:1.0188679245283019rem">arm64</a>
        
      
        
          
          
          &middot;
          <a href="/tags/authorization" style="font-size:1rem">authorization</a>
        
      
        
          
          
          &middot;
          <a href="/tags/backup" style="font-size:1.0377358490566038rem">backup</a>
        
      
        
          
          
          &middot;
          <a href="/tags/binarysearch" style="font-size:1.0188679245283019rem">binarysearch</a>
        
      
        
          
          
          &middot;
          <a href="/tags/binlog" style="font-size:1rem">binlog</a>
        
      
        
          
          
          &middot;
          <a href="/tags/bit" style="font-size:1.0188679245283019rem">bit</a>
        
      
        
          
          
          &middot;
          <a href="/tags/bug" style="font-size:1.0188679245283019rem">bug</a>
        
      
        
          
          
          &middot;
          <a href="/tags/cache" style="font-size:1rem">cache</a>
        
      
        
          
          
          &middot;
          <a href="/tags/certbot" style="font-size:1rem">certbot</a>
        
      
        
          
          
          &middot;
          <a href="/tags/channel" style="font-size:1rem">channel</a>
        
      
        
          
          
          &middot;
          <a href="/tags/chrome" style="font-size:1.0188679245283019rem">chrome</a>
        
      
        
          
          
          &middot;
          <a href="/tags/ci" style="font-size:1rem">ci</a>
        
      
        
          
          
          &middot;
          <a href="/tags/cluster" style="font-size:1.1132075471698113rem">cluster</a>
        
      
        
          
          
          &middot;
          <a href="/tags/cobra" style="font-size:1rem">cobra</a>
        
      
        
          
          
          &middot;
          <a href="/tags/coco" style="font-size:1.0377358490566038rem">coco</a>
        
      
        
          
          
          &middot;
          <a href="/tags/coding" style="font-size:1rem">coding</a>
        
      
        
          
          
          &middot;
          <a href="/tags/computer" style="font-size:1rem">computer</a>
        
      
        
          
          
          &middot;
          <a href="/tags/consul" style="font-size:1rem">consul</a>
        
      
        
          
          
          &middot;
          <a href="/tags/containerd" style="font-size:1.0188679245283019rem">containerd</a>
        
      
        
          
          
          &middot;
          <a href="/tags/coredns" style="font-size:1rem">coredns</a>
        
      
        
          
          
          &middot;
          <a href="/tags/cors" style="font-size:1rem">cors</a>
        
      
        
          
          
          &middot;
          <a href="/tags/crypto" style="font-size:1rem">crypto</a>
        
      
        
          
          
          &middot;
          <a href="/tags/curl" style="font-size:1rem">curl</a>
        
      
        
          
          
          &middot;
          <a href="/tags/dashboard" style="font-size:1rem">dashboard</a>
        
      
        
          
          
          &middot;
          <a href="/tags/dcdn" style="font-size:1rem">dcdn</a>
        
      
        
          
          
          &middot;
          <a href="/tags/debt" style="font-size:1rem">debt</a>
        
      
        
          
          
          &middot;
          <a href="/tags/devops" style="font-size:1.0188679245283019rem">devops</a>
        
      
        
          
          
          &middot;
          <a href="/tags/dingding" style="font-size:1rem">dingding</a>
        
      
        
          
          
          &middot;
          <a href="/tags/disk" style="font-size:1rem">disk</a>
        
      
        
          
          
          &middot;
          <a href="/tags/dmesg" style="font-size:1rem">dmesg</a>
        
      
        
          
          
          &middot;
          <a href="/tags/dns" style="font-size:1rem">dns</a>
        
      
        
          
          
          &middot;
          <a href="/tags/docker" style="font-size:1.2264150943396226rem">docker</a>
        
      
        
          
          
          &middot;
          <a href="/tags/doublylinkedlist" style="font-size:1rem">doublylinkedlist</a>
        
      
        
          
          
          &middot;
          <a href="/tags/elk" style="font-size:1rem">elk</a>
        
      
        
          
          
          &middot;
          <a href="/tags/error" style="font-size:1rem">error</a>
        
      
        
          
          
          &middot;
          <a href="/tags/etcd" style="font-size:1.0377358490566038rem">etcd</a>
        
      
        
          
          
          &middot;
          <a href="/tags/exec" style="font-size:1.0188679245283019rem">exec</a>
        
      
        
          
          
          &middot;
          <a href="/tags/exp" style="font-size:1rem">exp</a>
        
      
        
          
          
          &middot;
          <a href="/tags/federated" style="font-size:1rem">federated</a>
        
      
        
          
          
          &middot;
          <a href="/tags/filecoin" style="font-size:1rem">filecoin</a>
        
      
        
          
          
          &middot;
          <a href="/tags/find" style="font-size:1rem">find</a>
        
      
        
          
          
          &middot;
          <a href="/tags/firewalld" style="font-size:1rem">firewalld</a>
        
      
        
          
          
          &middot;
          <a href="/tags/fix" style="font-size:1.0377358490566038rem">fix</a>
        
      
        
          
          
          &middot;
          <a href="/tags/flag" style="font-size:1.0188679245283019rem">flag</a>
        
      
        
          
          
          &middot;
          <a href="/tags/flannel" style="font-size:1rem">flannel</a>
        
      
        
          
          
          &middot;
          <a href="/tags/food" style="font-size:1.0188679245283019rem">food</a>
        
      
        
          
          
          &middot;
          <a href="/tags/frp" style="font-size:1.0377358490566038rem">frp</a>
        
      
        
          
          
          &middot;
          <a href="/tags/ftp" style="font-size:1.0188679245283019rem">ftp</a>
        
      
        
          
          
          &middot;
          <a href="/tags/games" style="font-size:1rem">games</a>
        
      
        
          
          
          &middot;
          <a href="/tags/gin" style="font-size:1.0188679245283019rem">gin</a>
        
      
        
          
          
          &middot;
          <a href="/tags/git" style="font-size:1.2075471698113207rem">git</a>
        
      
        
          
          
          &middot;
          <a href="/tags/github" style="font-size:1.0188679245283019rem">github</a>
        
      
        
          
          
          &middot;
          <a href="/tags/gitlab" style="font-size:1rem">gitlab</a>
        
      
        
          
          
          &middot;
          <a href="/tags/go" style="font-size:1.320754716981132rem">go</a>
        
      
        
          
          
          &middot;
          <a href="/tags/go-vim" style="font-size:1rem">go-vim</a>
        
      
        
          
          
          &middot;
          <a href="/tags/gogs" style="font-size:1.0566037735849056rem">gogs</a>
        
      
        
          
          
          &middot;
          <a href="/tags/goland" style="font-size:1.0188679245283019rem">goland</a>
        
      
        
          
          
          &middot;
          <a href="/tags/golang" style="font-size:1.0377358490566038rem">golang</a>
        
      
        
          
          
          &middot;
          <a href="/tags/gorequest" style="font-size:1rem">gorequest</a>
        
      
        
          
          
          &middot;
          <a href="/tags/grafana" style="font-size:1.0188679245283019rem">grafana</a>
        
      
        
          
          
          &middot;
          <a href="/tags/grub" style="font-size:1rem">grub</a>
        
      
        
          
          
          &middot;
          <a href="/tags/hack" style="font-size:1.0188679245283019rem">hack</a>
        
      
        
          
          
          &middot;
          <a href="/tags/haproxy" style="font-size:1.0377358490566038rem">haproxy</a>
        
      
        
          
          
          &middot;
          <a href="/tags/harbor" style="font-size:1.0188679245283019rem">harbor</a>
        
      
        
          
          
          &middot;
          <a href="/tags/hash" style="font-size:1.0188679245283019rem">hash</a>
        
      
        
          
          
          &middot;
          <a href="/tags/hashmap" style="font-size:1rem">hashmap</a>
        
      
        
          
          
          &middot;
          <a href="/tags/helm" style="font-size:1.0188679245283019rem">helm</a>
        
      
        
          
          
          &middot;
          <a href="/tags/hexo" style="font-size:1.0377358490566038rem">hexo</a>
        
      
        
          
          
          &middot;
          <a href="/tags/http" style="font-size:1.0754716981132075rem">http</a>
        
      
        
          
          
          &middot;
          <a href="/tags/https" style="font-size:1rem">https</a>
        
      
        
          
          
          &middot;
          <a href="/tags/index" style="font-size:1rem">index</a>
        
      
        
          
          
          &middot;
          <a href="/tags/ingress" style="font-size:1.0377358490566038rem">ingress</a>
        
      
        
          
          
          &middot;
          <a href="/tags/inotify" style="font-size:1rem">inotify</a>
        
      
        
          
          
          &middot;
          <a href="/tags/internet" style="font-size:1.169811320754717rem">internet</a>
        
      
        
          
          
          &middot;
          <a href="/tags/interview" style="font-size:1rem">interview</a>
        
      
        
          
          
          &middot;
          <a href="/tags/iptables" style="font-size:1.0377358490566038rem">iptables</a>
        
      
        
          
          
          &middot;
          <a href="/tags/ipvs" style="font-size:1.0188679245283019rem">ipvs</a>
        
      
        
          
          
          &middot;
          <a href="/tags/java" style="font-size:1.0754716981132075rem">java</a>
        
      
        
          
          
          &middot;
          <a href="/tags/jeju" style="font-size:1rem">jeju</a>
        
      
        
          
          
          &middot;
          <a href="/tags/jenkins" style="font-size:1.0943396226415094rem">jenkins</a>
        
      
        
          
          
          &middot;
          <a href="/tags/jetbrains" style="font-size:1rem">jetbrains</a>
        
      
        
          
          
          &middot;
          <a href="/tags/jumpserver" style="font-size:1.0566037735849056rem">jumpserver</a>
        
      
        
          
          
          &middot;
          <a href="/tags/jvm" style="font-size:1rem">jvm</a>
        
      
        
          
          
          &middot;
          <a href="/tags/keepalived" style="font-size:1rem">keepalived</a>
        
      
        
          
          
          &middot;
          <a href="/tags/kernel" style="font-size:1rem">kernel</a>
        
      
        
          
          
          &middot;
          <a href="/tags/knowledge" style="font-size:1rem">knowledge</a>
        
      
        
          
          
          &middot;
          <a href="/tags/kube-proxy" style="font-size:1.0188679245283019rem">kube-proxy</a>
        
      
        
          
          
          &middot;
          <a href="/tags/kubernetes" style="font-size:1.3962264150943395rem">kubernetes</a>
        
      
        
          
          
          &middot;
          <a href="/tags/kubernetesrbac" style="font-size:1rem">kubernetesrbac</a>
        
      
        
          
          
          &middot;
          <a href="/tags/kubernetesssl" style="font-size:1.0188679245283019rem">kubernetesssl</a>
        
      
        
          
          
          &middot;
          <a href="/tags/kuboard" style="font-size:1.0566037735849056rem">kuboard</a>
        
      
        
          
          
          &middot;
          <a href="/tags/lb" style="font-size:1rem">lb</a>
        
      
        
          
          
          &middot;
          <a href="/tags/learning" style="font-size:1.0566037735849056rem">learning</a>
        
      
        
          
          
          &middot;
          <a href="/tags/leetcode" style="font-size:1.0188679245283019rem">leetcode</a>
        
      
        
          
          
          &middot;
          <a href="/tags/libcurl" style="font-size:1rem">libcurl</a>
        
      
        
          
          
          &middot;
          <a href="/tags/libssh2" style="font-size:1rem">libssh2</a>
        
      
        
          
          
          &middot;
          <a href="/tags/link" style="font-size:1rem">link</a>
        
      
        
          
          
          &middot;
          <a href="/tags/linux" style="font-size:1.9811320754716981rem">linux</a>
        
      
        
          
          
          &middot;
          <a href="/tags/living" style="font-size:1rem">living</a>
        
      
        
          
          
          &middot;
          <a href="/tags/lnux" style="font-size:1rem">lnux</a>
        
      
        
          
          
          &middot;
          <a href="/tags/log" style="font-size:1.0566037735849056rem">log</a>
        
      
        
          
          
          &middot;
          <a href="/tags/logrus" style="font-size:1rem">logrus</a>
        
      
        
          
          
          &middot;
          <a href="/tags/logs" style="font-size:1rem">logs</a>
        
      
        
          
          
          &middot;
          <a href="/tags/logstash" style="font-size:1rem">logstash</a>
        
      
        
          
          
          &middot;
          <a href="/tags/loki" style="font-size:1rem">loki</a>
        
      
        
          
          
          &middot;
          <a href="/tags/lru" style="font-size:1rem">lru</a>
        
      
        
          
          
          &middot;
          <a href="/tags/luna" style="font-size:1rem">luna</a>
        
      
        
          
          
          &middot;
          <a href="/tags/lvm" style="font-size:1rem">lvm</a>
        
      
        
          
          
          &middot;
          <a href="/tags/lvs" style="font-size:1rem">lvs</a>
        
      
        
          
          
          &middot;
          <a href="/tags/mac" style="font-size:1rem">mac</a>
        
      
        
          
          
          &middot;
          <a href="/tags/malaysia" style="font-size:1rem">malaysia</a>
        
      
        
          
          
          &middot;
          <a href="/tags/manage" style="font-size:1rem">manage</a>
        
      
        
          
          
          &middot;
          <a href="/tags/map" style="font-size:1rem">map</a>
        
      
        
          
          
          &middot;
          <a href="/tags/mariadb" style="font-size:1.0377358490566038rem">mariadb</a>
        
      
        
          
          
          &middot;
          <a href="/tags/markdown" style="font-size:1.0188679245283019rem">markdown</a>
        
      
        
          
          
          &middot;
          <a href="/tags/mfa" style="font-size:1rem">mfa</a>
        
      
        
          
          
          &middot;
          <a href="/tags/mha" style="font-size:1rem">mha</a>
        
      
        
          
          
          &middot;
          <a href="/tags/mode" style="font-size:1rem">mode</a>
        
      
        
          
          
          &middot;
          <a href="/tags/module" style="font-size:1rem">module</a>
        
      
        
          
          
          &middot;
          <a href="/tags/mount" style="font-size:1rem">mount</a>
        
      
        
          
          
          &middot;
          <a href="/tags/mysql" style="font-size:1.2452830188679245rem">mysql</a>
        
      
        
          
          
          &middot;
          <a href="/tags/navicat" style="font-size:1rem">navicat</a>
        
      
        
          
          
          &middot;
          <a href="/tags/network" style="font-size:1rem">network</a>
        
      
        
          
          
          &middot;
          <a href="/tags/nfs" style="font-size:1.0754716981132075rem">nfs</a>
        
      
        
          
          
          &middot;
          <a href="/tags/nginx" style="font-size:1.2264150943396226rem">nginx</a>
        
      
        
          
          
          &middot;
          <a href="/tags/nginxingress" style="font-size:1.0566037735849056rem">nginxingress</a>
        
      
        
          
          
          &middot;
          <a href="/tags/node_exporter" style="font-size:1.0188679245283019rem">node_exporter</a>
        
      
        
          
          
          &middot;
          <a href="/tags/numpy" style="font-size:1rem">numpy</a>
        
      
        
          
          
          &middot;
          <a href="/tags/ops" style="font-size:1.2452830188679245rem">ops</a>
        
      
        
          
          
          &middot;
          <a href="/tags/owncloud" style="font-size:1rem">owncloud</a>
        
      
        
          
          
          &middot;
          <a href="/tags/password" style="font-size:1rem">password</a>
        
      
        
          
          
          &middot;
          <a href="/tags/paxos" style="font-size:1.0188679245283019rem">paxos</a>
        
      
        
          
          
          &middot;
          <a href="/tags/php" style="font-size:1rem">php</a>
        
      
        
          
          
          &middot;
          <a href="/tags/pipeline" style="font-size:1rem">pipeline</a>
        
      
        
          
          
          &middot;
          <a href="/tags/polynomial" style="font-size:1rem">polynomial</a>
        
      
        
          
          
          &middot;
          <a href="/tags/problem" style="font-size:1rem">problem</a>
        
      
        
          
          
          &middot;
          <a href="/tags/prometheus" style="font-size:1.0943396226415094rem">prometheus</a>
        
      
        
          
          
          &middot;
          <a href="/tags/pv" style="font-size:1.0754716981132075rem">pv</a>
        
      
        
          
          
          &middot;
          <a href="/tags/pvc" style="font-size:1.0754716981132075rem">pvc</a>
        
      
        
          
          
          &middot;
          <a href="/tags/python" style="font-size:1.0943396226415094rem">python</a>
        
      
        
          
          
          &middot;
          <a href="/tags/queue" style="font-size:1rem">queue</a>
        
      
        
          
          
          &middot;
          <a href="/tags/qw3xt" style="font-size:1rem">qw3xt</a>
        
      
        
          
          
          &middot;
          <a href="/tags/rabbitmq" style="font-size:1.0188679245283019rem">rabbitmq</a>
        
      
        
          
          
          &middot;
          <a href="/tags/raft" style="font-size:1rem">raft</a>
        
      
        
          
          
          &middot;
          <a href="/tags/rebase" style="font-size:1rem">rebase</a>
        
      
        
          
          
          &middot;
          <a href="/tags/redis" style="font-size:1.0377358490566038rem">redis</a>
        
      
        
          
          
          &middot;
          <a href="/tags/resources" style="font-size:1.0188679245283019rem">resources</a>
        
      
        
          
          
          &middot;
          <a href="/tags/rsa" style="font-size:1rem">rsa</a>
        
      
        
          
          
          &middot;
          <a href="/tags/rsync" style="font-size:1.0188679245283019rem">rsync</a>
        
      
        
          
          
          &middot;
          <a href="/tags/safe" style="font-size:1.0754716981132075rem">safe</a>
        
      
        
          
          
          &middot;
          <a href="/tags/samba" style="font-size:1rem">samba</a>
        
      
        
          
          
          &middot;
          <a href="/tags/sealos" style="font-size:1rem">sealos</a>
        
      
        
          
          
          &middot;
          <a href="/tags/secure" style="font-size:1rem">secure</a>
        
      
        
          
          
          &middot;
          <a href="/tags/sed" style="font-size:1rem">sed</a>
        
      
        
          
          
          &middot;
          <a href="/tags/server" style="font-size:1.2075471698113207rem">server</a>
        
      
        
          
          
          &middot;
          <a href="/tags/sftp" style="font-size:1rem">sftp</a>
        
      
        
          
          
          &middot;
          <a href="/tags/shadowsocks" style="font-size:1.0188679245283019rem">shadowsocks</a>
        
      
        
          
          
          &middot;
          <a href="/tags/shell" style="font-size:1.0188679245283019rem">shell</a>
        
      
        
          
          
          &middot;
          <a href="/tags/slap" style="font-size:1rem">slap</a>
        
      
        
          
          
          &middot;
          <a href="/tags/slave" style="font-size:1rem">slave</a>
        
      
        
          
          
          &middot;
          <a href="/tags/slb" style="font-size:1rem">slb</a>
        
      
        
          
          
          &middot;
          <a href="/tags/slowquery" style="font-size:1rem">slowquery</a>
        
      
        
          
          
          &middot;
          <a href="/tags/sonar" style="font-size:1.0377358490566038rem">sonar</a>
        
      
        
          
          
          &middot;
          <a href="/tags/sourcetree" style="font-size:1.0188679245283019rem">sourcetree</a>
        
      
        
          
          
          &middot;
          <a href="/tags/sql" style="font-size:1.0188679245283019rem">sql</a>
        
      
        
          
          
          &middot;
          <a href="/tags/ss" style="font-size:1rem">ss</a>
        
      
        
          
          
          &middot;
          <a href="/tags/ssh" style="font-size:1.0754716981132075rem">ssh</a>
        
      
        
          
          
          &middot;
          <a href="/tags/ssl" style="font-size:1.1132075471698113rem">ssl</a>
        
      
        
          
          
          &middot;
          <a href="/tags/stack" style="font-size:1rem">stack</a>
        
      
        
          
          
          &middot;
          <a href="/tags/stress" style="font-size:1rem">stress</a>
        
      
        
          
          
          &middot;
          <a href="/tags/style" style="font-size:1rem">style</a>
        
      
        
          
          
          &middot;
          <a href="/tags/switchyomega" style="font-size:1rem">switchyomega</a>
        
      
        
          
          
          &middot;
          <a href="/tags/syncd" style="font-size:1rem">syncd</a>
        
      
        
          
          
          &middot;
          <a href="/tags/taint" style="font-size:1rem">taint</a>
        
      
        
          
          
          &middot;
          <a href="/tags/tar" style="font-size:1rem">tar</a>
        
      
        
          
          
          &middot;
          <a href="/tags/tcp" style="font-size:1.0188679245283019rem">tcp</a>
        
      
        
          
          
          &middot;
          <a href="/tags/testing" style="font-size:1rem">testing</a>
        
      
        
          
          
          &middot;
          <a href="/tags/tomcat" style="font-size:1rem">tomcat</a>
        
      
        
          
          
          &middot;
          <a href="/tags/tour" style="font-size:1.0188679245283019rem">tour</a>
        
      
        
          
          
          &middot;
          <a href="/tags/trojan" style="font-size:1rem">trojan</a>
        
      
        
          
          
          &middot;
          <a href="/tags/ubuntu" style="font-size:1.0566037735849056rem">ubuntu</a>
        
      
        
          
          
          &middot;
          <a href="/tags/udp" style="font-size:1rem">udp</a>
        
      
        
          
          
          &middot;
          <a href="/tags/uk8s" style="font-size:1rem">uk8s</a>
        
      
        
          
          
          &middot;
          <a href="/tags/unauthorized" style="font-size:1rem">unauthorized</a>
        
      
        
          
          
          &middot;
          <a href="/tags/unblockneteasemusic" style="font-size:1rem">unblockneteasemusic</a>
        
      
        
          
          
          &middot;
          <a href="/tags/upgrade" style="font-size:1.0188679245283019rem">upgrade</a>
        
      
        
          
          
          &middot;
          <a href="/tags/upstream" style="font-size:1rem">upstream</a>
        
      
        
          
          
          &middot;
          <a href="/tags/v1.18.3" style="font-size:1rem">v1.18.3</a>
        
      
        
          
          
          &middot;
          <a href="/tags/vim" style="font-size:1rem">vim</a>
        
      
        
          
          
          &middot;
          <a href="/tags/virtul" style="font-size:1rem">virtul</a>
        
      
        
          
          
          &middot;
          <a href="/tags/vpn" style="font-size:1.0754716981132075rem">vpn</a>
        
      
        
          
          
          &middot;
          <a href="/tags/vscode" style="font-size:1rem">vscode</a>
        
      
        
          
          
          &middot;
          <a href="/tags/websocket" style="font-size:1rem">websocket</a>
        
      
        
          
          
          &middot;
          <a href="/tags/wifi" style="font-size:1rem">wifi</a>
        
      
        
          
          
          &middot;
          <a href="/tags/xshell" style="font-size:1rem">xshell</a>
        
      
        
          
          
          &middot;
          <a href="/tags/xtrabackup" style="font-size:1rem">xtrabackup</a>
        
      
        
          
          
          &middot;
          <a href="/tags/yum" style="font-size:1rem">yum</a>
        
      
        
          
          
          &middot;
          <a href="/tags/zabbix" style="font-size:1rem">zabbix</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e6%95%b0%e6%8d%ae%e5%ba%93%e5%8e%9f%e7%90%86" style="font-size:1rem">数据库原理</a>
        
      
        
          
          
          &middot;
          <a href="/tags/%e8%b4%aa%e5%bf%83%e7%ae%97%e6%b3%95" style="font-size:1rem">贪心算法</a>
        
      
      </div>
    
  </div>

  <!-- profile -->
  <!-- toc -->
  
  <div class="bg-white px-4 py-5 box-shadow mb-5 sticky-top">
    <h4 class="mb-4">目录</h4>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#问题描述和假设">问题描述和假设</a>
      <ul>
        <li><a href="#算法的提出与证明">算法的提出与证明</a></li>
      </ul>
    </li>
    <li><a href="#golang实现"><code>golang</code>实现</a>
      <ul>
        <li><a href="#实现的步骤">实现的步骤</a></li>
        <li><a href="#代码">代码</a></li>
        <li><a href="#验证结果">验证结果:</a></li>
        <li><a href="#参考">参考</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>

</aside>
<!-- /sidebar -->

    </div>
  </div>
</section>
<!-- /blog details -->



<footer>
	
	<div class="section bg-secondary">
		<div class="container">
			<div class="row justify-content-between">
				
				<div class="col-lg-5 mb-5 mb-lg-0">
					
					<a class="mb-4 d-inline-block" href="/"><img class="img-fluid"
																								src="/images/images/logo-alt.png" alt="Louis Blog" width="60%"></a>
					<p class="text-light mb-5">每一个不曾起舞的日子都是对生命的辜负.</p>
					<h4 class="text-white mb-4">关注我</h4>
					
					<ul class="list-inline social-icon-alt">
						
						<li class="list-inline-item">
							<a class="hover-ripple" href="https://twitter.com/louishong17"><i class="fa fa-twitter"></i></a>
						</li>
						
						<li class="list-inline-item">
							<a class="hover-ripple" href="https://github.com/oldthreefeng"><i class="fa fa-github"></i></a>
						</li>
						
						<li class="list-inline-item">
							<a class="hover-ripple" href="/contact"><i class="fa fa-wechat"></i></a>
						</li>
						
						<li class="list-inline-item">
							<a class="hover-ripple" href="mailto:992165098@qq.com"><i class="fa fa-envelope"></i></a>
						</li>
						
						<li class="list-inline-item">
							<a class="hover-ripple" href="https://www.fenghong.tech/blog/index.xml"><i class="fa fa-rss"></i></a>
						</li>
						
					</ul>
				</div>
				<div class="col-lg-5 mb-5 mb-lg-0">
					
					
					
					
					
					<div class="mb-5">
						<h4 class="text-white mb-4">联系信息</h4>
						<p class="text-light mb-3">上海 · 浦东新区</p>
						<p class="text-light mb-3"></p>
						<p class="text-light mb-3">微信联系方式</p>
						<p class="text-light mb-3"><img src="/images/images/wechat-qrcode.png" width="356px"></p>
					</div>
					
					
				</div>
			</div>
		</div>
	</div>
	
	<div class="bg-secondary-darken py-4">
		<div class="container">
			<div class="row">
				<div class="col-md-6 text-center text-md-left mb-3 mb-md-0">
					<p class="mb-0 text-white">Copyright © 2020 Louis</p>
				</div>
				<div class="col-md-6 text-center text-md-right">
					<ul class="list-inline">
						
						<li class="list-inline-item mx-0"><a class="d-inline-block px-3 text-white" href="https://beian.miit.gov.cn/"
																									class="text-white">鄂ICP备18027870号-1</a></li>
						<p class="list-inline-item mx-0 text-white">本网站由</p>
						<a target="_blank" rel="nofollow noopener" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"><img src="https://pic.fenghong.tech/images/180803_logo30.png" style="margin-bottom:5px;height: 25px;"></a>
						<p class="list-inline-item mx-0 text-white">提供CDN加速/云存储服务</p>
						
					</ul>
				</div>
			</div>
		</div>
	</div>
</footer>



<script>
	var indexURL = "/index.json"
</script>


<!-- JS Plugins -->

<script src="/plugins/jQuery/jquery.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/google-map/gmap.js"></script>

<script src="/plugins/venobox/venobox.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/search/search.js"></script>

<script src="/plugins/bigPicture/bigPicture.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>


<!-- Main Script -->

<script src="/js/script.min.js"></script>

<!-- Algolia -->
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js"></script>
<script>
	docsearch({
		apiKey: 'b4d47f0c039a84d4035305be829404dd',
		indexName: 'DocSearch',
		appId: 'CTH4P282IZ',
		inputSelector: '#js-algolia-btn',
		debug: false,
	});
</script>

<!-- google analitycs -->

<script>
	(function (i, s, o, g, r, a, m) {
		i['GoogleAnalyticsObject'] = r;
		i[r] = i[r] || function () {
			(i[r].q = i[r].q || []).push(arguments)
		}, i[r].l = 1 * new Date();
		a = s.createElement(o),
			m = s.getElementsByTagName(o)[0];
		a.async = 1;
		a.src = g;
		m.parentNode.insertBefore(a, m)
	})(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-130595069-1', 'auto');
ga('send', 'pageview');
</script>


<script>
	(function(){
		var bp = document.createElement('script');
		var curProtocol = window.location.protocol.split(':')[0];
		if (curProtocol === 'https'){
			bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
		}
		else{
			bp.src = 'http://push.zhanzhang.baidu.com/push.js';
		}
		var s = document.getElementsByTagName("script")[0];
		s.parentNode.insertBefore(bp, s);
	})();
</script>
</body>

</html>